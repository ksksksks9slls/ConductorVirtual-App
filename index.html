<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orchestra V34 - Master & Free Mode</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        :root { --neon: #00ffea; }
        body { margin: 0; background: #000; color: var(--neon); font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        video { position: fixed; width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); opacity: 0.8; display: none; }
        canvas { position: fixed; width: 100%; height: 100%; z-index: 5; transform: scaleX(-1); pointer-events: none; }
        
        /* Pantallas */
        .screen { position: fixed; inset: 0; z-index: 10; display: flex; flex-direction: column; justify-content: center; align-items: center; background: rgba(0,0,0,0.9); text-align: center; padding: 20px; }
        .hidden { display: none !important; }
        
        .card { background: #111; padding: 30px; border: 2px solid var(--neon); border-radius: 20px; width: 100%; max-width: 400px; }
        .btn { background: var(--neon); color: #000; border: none; padding: 15px 30px; margin: 10px; border-radius: 10px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .btn:disabled { background: #444; cursor: not-allowed; }
        
        /* HUD y Calibración */
        #calib-status { font-family: monospace; font-size: 1.2em; margin: 20px 0; }
        #progress-bar { width: 100%; height: 10px; background: #222; border-radius: 5px; overflow: hidden; margin: 10px 0; }
        #progress-fill { width: 0%; height: 100%; background: var(--neon); transition: 0.3s; }
        #hud-live { position: fixed; top: 20px; width: 100%; text-align: center; z-index: 15; font-size: 1.5em; text-shadow: 0 0 10px #000; }
    </style>
</head>
<body>

    <video id="input_video" playsinline muted></video>
    <canvas id="output_canvas"></canvas>

    <div id="menu-screen" class="screen">
        <div class="card">
            <h1>ORCHESTRA PRO</h1>
            <p>1. Selecciona tu obra</p>
            <input type="file" id="audio-file" accept="audio/*" style="margin-bottom: 20px;">
            <div style="display: flex; gap: 10px;">
                <button class="btn" onclick="preStart('maestro')" id="btn-maestro">MODO MAESTRO</button>
                <button class="btn" onclick="preStart('libre')" id="btn-libre">MODO LIBRE</button>
            </div>
        </div>
    </div>

    <div id="calib-screen" class="screen hidden">
        <div class="card">
            <h2 id="step-title">ESCANEANDO...</h2>
            <div id="progress-bar"><div id="progress-fill"></div></div>
            <p id="step-desc">Ponte frente a la cámara</p>
            <div id="calib-confirm" class="hidden">
                <p>¿Calibración correcta?</p>
                <button class="btn" onclick="confirmCalib(true)">SÍ</button>
                <button class="btn" style="background:#ff4444" onclick="confirmCalib(false)">NO</button>
            </div>
        </div>
    </div>

    <div id="analysis-screen" class="screen hidden">
        <div class="card pulse">
            <h2>ANALIZANDO RITMO...</h2>
            <p>Sincronizando orquesta con MP3</p>
        </div>
    </div>

    <div id="start-screen" class="screen hidden" style="background: rgba(0,0,0,0.4);">
        <h1 style="font-size: 3em;">DA 3 GOLPES SECOS</h1>
        <div id="beats-count" style="font-size: 5em;">0 / 3</div>
    </div>

    <div id="hud-live" class="hidden"></div>

    <script>
        const state = { mode: '', step: 0, audioLoaded: false, calibrated: false, beats: 0 };
        const video = document.getElementById('input_video');
        const canvas = document.getElementById('output_canvas');
        const ctx = canvas.getContext('2d');
        let player, pose, camera;

        // --- 1. SELECCIÓN Y MENÚ ---
        function preStart(mode) {
            if (!document.getElementById('audio-file').files[0]) return alert("Sube una canción primero");
            state.mode = mode;
            loadAudio();
            document.getElementById('menu-screen').classList.add('hidden');
            document.getElementById('calib-screen').classList.remove('hidden');
            video.style.display = 'block';
            startPose();
        }

        async function loadAudio() {
            const file = document.getElementById('audio-file').files[0];
            const url = URL.createObjectURL(file);
            player = new Tone.Player(url).toDestination();
            state.audioLoaded = true;
            player.onstop = () => location.reload(); // Redirige al terminar
        }

        // --- 2. CALIBRACIÓN SECUENCIAL ---
        const calibSteps = [
            { id: 'hombros', desc: 'Detectando hombros...', parts: [11, 12] },
            { id: 'brazos', desc: 'Analizando brazos y manos...', parts: [13, 14, 15, 16, 19, 20] },
            { id: 'torso', desc: 'Mapeando torso...', parts: [23, 24] },
            { id: 'pies', desc: 'Muestra tus pies para finalizar...', parts: [27, 28] }
        ];

        function startPose() {
            pose = new Pose({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`});
            pose.setOptions({ modelComplexity: 1, smoothLandmarks: true, minDetectionConfidence: 0.7 });
            pose.onResults(onResults);
            camera = new Camera(video, { onFrame: async () => await pose.send({image: video}), width: 640, height: 480 });
            camera.start();
        }

        function onResults(results) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            canvas.width = window.innerWidth; canvas.height = window.innerHeight;
            if (!results.poseLandmarks) return;
            
            drawBones(results.poseLandmarks);

            if (!state.calibrated) {
                runCalibration(results.poseLandmarks);
            } else if (state.readyToDirect) {
                direct(results.poseLandmarks);
            }
        }

        function runCalibration(lm) {
            let currentStep = calibSteps[state.step];
            let allVisible = currentStep.parts.every(p => lm[p] && lm[p].visibility > 0.8);

            if (allVisible) {
                let progress = ((state.step + 1) / calibSteps.length) * 100;
                document.getElementById('progress-fill').style.width = progress + '%';
                document.getElementById('step-title').innerText = currentStep.id.toUpperCase();
                document.getElementById('step-desc').innerText = currentStep.desc;

                if (progress >= 100) {
                    document.getElementById('calib-confirm').classList.remove('hidden');
                    document.getElementById('step-desc').innerText = "Calibración completa al 100%";
                } else {
                    state.step++;
                }
            }
        }

        function confirmCalib(success) {
            if (success) {
                state.calibrated = true;
                document.getElementById('calib-screen').classList.add('hidden');
                analyzeMusic();
            } else {
                state.step = 0;
                document.getElementById('progress-fill').style.width = '0%';
                document.getElementById('calib-confirm').classList.add('hidden');
            }
        }

        // --- 3. ANÁLISIS DE MÚSICA ---
        function analyzeMusic() {
            document.getElementById('analysis-screen').classList.remove('hidden');
            // Simulación de análisis de BPM real
            setTimeout(() => {
                document.getElementById('analysis-screen').classList.add('hidden');
                document.getElementById('start-screen').classList.remove('hidden');
                state.listeningBeats = true;
            }, 3000);
        }

        // --- 4. LOS 3 GOLPES Y CONCIERTO ---
        let lastY = 0;
        function direct(lm) {
            const hand = lm[20]; // Mano derecha
            let motion = Math.abs(hand.y - lastY) * 100;

            if (state.listeningBeats) {
                if (motion > 10) {
                    state.beats++;
                    document.getElementById('beats-count').innerText = `${state.beats} / 3`;
                    if (state.beats >= 3) {
                        state.listeningBeats = false;
                        startConcert();
                    }
                }
            } else if (isPlaying) {
                // Lógica de audio (Modo Libre vs Maestro)
                if (motion > 0.5) {
                    player.playbackRate = state.mode === 'maestro' ? (0.5 + motion/10) : 1.0;
                    player.mute = false;
                } else {
                    player.mute = true; // Parada seca
                }
            }
            lastY = hand.y;
        }

        function startConcert() {
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('hud-live').classList.remove('hidden');
            document.getElementById('hud-live').innerText = state.mode === 'maestro' ? "MODO MAESTRO: CONTROLA EL TEMPO" : "MODO LIBRE: MUEVE LAS MANOS";
            player.start();
            isPlaying = true;
            state.readyToDirect = true;
        }

        function drawBones(lm) {
            ctx.strokeStyle = "#00ffea"; ctx.lineWidth = 5;
            const conn = [[11,12], [11,13], [13,15], [12,14], [14,16], [11,23], [12,24], [23,24], [23,25], [24,26], [25,27], [26,28]];
            conn.forEach(([a,b]) => {
                if (lm[a].visibility > 0.5 && lm[b].visibility > 0.5) {
                    ctx.beginPath();
                    ctx.moveTo(lm[a].x * canvas.width, lm[a].y * canvas.height);
                    ctx.lineTo(lm[b].x * canvas.width, lm[b].y * canvas.height);
                    ctx.stroke();
                }
            });
        }
    </script>
</body>
</html>
