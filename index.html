<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Maestro AI 12.0 - Anatómico</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #050505; overflow: hidden; font-family: 'Segoe UI', sans-serif; }
        .input_video { position: fixed; width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); z-index: 0; opacity: 0.6; } /* Opacidad constante */
        .output_canvas { position: fixed; width: 100%; height: 100%; z-index: 1; transform: scaleX(-1); pointer-events: none; }
        
        #ui-layer { position: fixed; inset: 0; z-index: 10; display: flex; flex-direction: column; justify-content: center; align-items: center; background: rgba(0,0,0,0.4); text-align: center; }
        .panel { background: rgba(20, 20, 20, 0.9); padding: 30px; border-radius: 40px; border: 1px solid rgba(0,255,234,0.3); width: 85%; max-width: 400px; color: white; backdrop-filter: blur(10px); }
        
        .btn { padding: 20px; background: #00ffea; color: #000; border: none; border-radius: 50px; font-weight: bold; cursor: pointer; margin: 15px 0; width: 100%; text-transform: uppercase; letter-spacing: 1px; }
        #status-msg { margin-top: 15px; color: #00ffea; font-family: monospace; font-size: 1.1em; text-shadow: 0 0 10px rgba(0,255,234,0.5); }
        #ritual-hint { position: fixed; top: 15%; width: 100%; text-align: center; font-size: 2em; color: #fff; font-weight: bold; z-index: 10; display: none; text-shadow: 0 0 20px #00ffea; }
    </style>
</head>
<body>

    <video class="input_video" playsinline muted></video>
    <canvas class="output_canvas"></canvas>
    <div id="ritual-hint">LEVANTA LA BATUTA</div>

    <div id="ui-layer">
        <div id="panel-content" class="panel">
            <h1 style="color:#00ffea; margin-bottom:10px;">MAESTRO 12.0</h1>
            <p id="desc">Sincroniza tu cuerpo con la orquesta.</p>
            <div id="actions">
                <input type="file" id="audio-input" accept="audio/*" style="display:none">
                <button class="btn" onclick="document.getElementById('audio-input').click()">CARGAR OBRA</button>
            </div>
            <div id="status-msg">ESPERANDO AUDIO...</div>
        </div>
    </div>

    <script>
        const videoElement = document.querySelector('.input_video');
        const canvasElement = document.querySelector('.output_canvas');
        const canvasCtx = canvasElement.getContext('2d');
        const audioInput = document.getElementById('audio-input');

        let player, isPlaying = false;
        let flowState = "START"; 
        let calProgress = 0, golpesDados = 0, useBaton = false;
        let lastY = 0, subiendo = false, detectadoEnAlto = false;

        const woodTap = new Tone.MembraneSynth({
            pitchDecay: 0.005, envelope: { attack: 0.001, decay: 0.1, sustain: 0 }
        }).toDestination();

        audioInput.onchange = async (e) => {
            const file = e.target.files[0];
            if (file) {
                await Tone.start();
                player = new Tone.Player(URL.createObjectURL(file)).toDestination();
                flowState = "CAL_BODY";
                updateUI();
                initPose();
            }
        };

        function updateUI() {
            const actions = document.getElementById('actions');
            if (flowState === "CHOOSE_BATON") {
                actions.innerHTML = `
                    <button class="btn" onclick="confirmBaton(true)">MODO BATUTA</button>
                    <button class="btn" style="background:#333;color:#eee" onclick="confirmBaton(false)">MODO MANO LIBRE</button>
                `;
            } else if (flowState === "RITUAL") {
                document.getElementById('ui-layer').style.display = "none";
                document.getElementById('ritual-hint').style.display = "block";
            }
        }

        function confirmBaton(val) {
            useBaton = val;
            flowState = useBaton ? "CAL_BATON" : "RITUAL";
            calProgress = 0;
            updateUI();
        }

        function initPose() {
            const pose = new Pose({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`});
            pose.setOptions({ modelComplexity: 1, smoothLandmarks: true, minDetectionConfidence: 0.6 });
            pose.onResults(onResults);
            new Camera(videoElement, { onFrame: async () => { await pose.send({image: videoElement}); }, width: 640, height: 480 }).start();
        }

        function onResults(results) {
            canvasElement.width = window.innerWidth;
            canvasElement.height = window.innerHeight;
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);

            if (results.poseLandmarks) {
                const lm = results.poseLandmarks;
                drawRealisticSkeleton(lm);

                if (flowState === "CAL_BODY") {
                    calProgress += 0.8;
                    document.getElementById('status-msg').innerText = `ESCANEO ANATÓMICO: ${Math.min(100, Math.round(calProgress))}%`;
                    if (calProgress >= 100) { flowState = "CHOOSE_BATON"; updateUI(); }
                }

                if (flowState === "CAL_BATON") {
                    const dist = Math.hypot(lm[16].x - lm[20].x, lm[16].y - lm[20].y);
                    if (dist > 0.1) { // Solo si el objeto sobresale significativamente
                        calProgress += 1.5;
                        document.getElementById('status-msg').innerText = `VINCULANDO BATUTA: ${Math.min(100, Math.round(calProgress))}%`;
                        if (calProgress >= 100) { flowState = "RITUAL"; updateUI(); }
                    } else {
                        document.getElementById('status-msg').innerText = "ERROR: OBJETO NO DETECTADO";
                    }
                }

                const ref = useBaton ? lm[20] : lm[16];

                if (flowState === "RITUAL") {
                    if (ref.y < 0.35) {
                        detectadoEnAlto = true;
                        document.getElementById('ritual-hint').innerText = "¡3 GOLPES RÁPIDOS!";
                    }
                    if (detectadoEnAlto) {
                        if (lastY < ref.y - 0.08 && !subiendo) {
                            woodTap.triggerAttackRelease("G2", "16n");
                            golpesDados++;
                            subiendo = true;
                            if (golpesDados >= 3) {
                                player.start();
                                flowState = "PLAYING";
                                isPlaying = true;
                                document.getElementById('ritual-hint').style.display = "none";
                            }
                        }
                        if (ref.y < lastY - 0.06) subiendo = false;
                    }
                }

                if (isPlaying) {
                    const speed = Math.abs(ref.y - lastY) * 100;
                    if (speed < 0.05) { // Parada seca
                        player.stop(); isPlaying = false; location.reload();
                    } else {
                        player.playbackRate = Math.min(Math.max(speed / 7, 0.7), 1.8);
                    }
                }
                lastY = ref.y;
            }
        }

        function drawRealisticSkeleton(lm) {
            const p = (i) => ({ x: lm[i].x * canvasElement.width, y: lm[i].y * canvasElement.height });
            
            // Estilo de Hueso Realista
            const drawBone = (from, to, thickness) => {
                canvasCtx.beginPath();
                canvasCtx.lineWidth = thickness;
                canvasCtx.strokeStyle = "rgba(230, 230, 230, 0.9)";
                canvasCtx.lineCap = "round";
                canvasCtx.moveTo(from.x, from.y);
                canvasCtx.lineTo(to.x, to.y);
                canvasCtx.stroke();
                
                // Brillo interno
                canvasCtx.lineWidth = thickness / 2;
                canvasCtx.strokeStyle = "rgba(0, 255, 234, 0.4)";
                canvasCtx.stroke();
            };

            // Dibujar estructura completa
            const connections = [
                [11, 12, 10], [11, 13, 8], [13, 15, 6], [12, 14, 8], [14, 16, 6], // Torso y brazos
                [11, 23, 10], [12, 24, 10], [23, 24, 10], // Cadera
                [23, 25, 10], [25, 27, 8], [24, 26, 10], [26, 28, 8] // Piernas
            ];

            connections.forEach(([f, t, w]) => drawBone(p(f), p(t), w));

            // Cráneo (Simplificado elegante)
            canvasCtx.fillStyle = "rgba(230, 230, 230, 0.9)";
            canvasCtx.beginPath();
            canvasCtx.arc(p(0).x, p(0).y, 25, 0, Math.PI * 2);
            canvasCtx.fill();

            // Batuta con detector de objeto largo
            if (useBaton && (flowState === "CAL_BATON" || flowState === "RITUAL" || isPlaying)) {
                const handDist = Math.hypot(lm[16].x - lm[20].x, lm[16].y - lm[20].y);
                if (handDist > 0.08) {
                    canvasCtx.shadowBlur = 15;
                    canvasCtx.shadowColor = "#00ffea";
                    drawBone(p(16), p(20), 4);
                    canvasCtx.shadowBlur = 0;
                    
                    canvasCtx.fillStyle = "#fff";
                    canvasCtx.beginPath(); canvasCtx.arc(p(20).x, p(20).y, 6, 0, 7); canvasCtx.fill();
                }
            }
        }
    </script>
</body>
</html>
