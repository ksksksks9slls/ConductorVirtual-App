<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Orchestra V28 - Ultimate Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        body { margin: 0; background: #000; color: #00ffea; font-family: sans-serif; overflow: hidden; touch-action: none; }
        .input_video { position: fixed; width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); opacity: 0.2; }
        .output_canvas { position: fixed; width: 100%; height: 100%; z-index: 5; transform: scaleX(-1); }
        #ui { position: fixed; inset: 0; z-index: 10; display: flex; flex-direction: column; justify-content: center; align-items: center; background: rgba(0,0,0,0.9); padding: 20px; }
        .box { background: #111; padding: 25px; border: 2px solid #00ffea; border-radius: 20px; text-align: center; max-width: 320px; }
        .btn { background: #00ffea; color: #000; padding: 18px; border: none; font-weight: bold; border-radius: 12px; width: 100%; margin-top: 15px; }
        #hud { position: fixed; top: 30px; width: 100%; text-align: center; z-index: 6; font-family: monospace; font-size: 14px; }
        #energy-bar { position: fixed; bottom: 20px; left: 10%; width: 80%; height: 10px; background: #222; border-radius: 5px; z-index: 7; overflow: hidden; }
        #energy-fill { width: 100%; height: 100%; background: #00ffea; transition: width 0.1s; }
    </style>
</head>
<body>
    <video class="input_video" playsinline muted></video>
    <canvas class="output_canvas"></canvas>
    <div id="hud">MAESTRO LISTO</div>
    <div id="energy-bar"><div id="energy-fill"></div></div>

    <div id="ui">
        <div class="box">
            <h2 style="margin:0">ORCHESTRA V28</h2>
            <p style="font-size: 0.7em; margin: 10px 0;">Vibración, Energía e Intensidad activas</p>
            <input type="file" id="audio-file" accept="audio/*">
            <button class="btn" onclick="startFinal()">INICIAR CONCIERTO</button>
        </div>
    </div>

    <script>
        const video = document.querySelector('.input_video');
        const canvas = document.querySelector('.output_canvas');
        const ctx = canvas.getContext('2d');
        const fileInput = document.getElementById('audio-file');
        const energyFill = document.getElementById('energy-fill');

        let player, filter, panner, isPlaying = false;
        let lastPos = {x: 0, y: 0}, energy = 100, path = [];

        async function startFinal() {
            if (!fileInput.files[0]) return alert("Sube tu MP3 primero");
            await Tone.start();
            const url = URL.createObjectURL(fileInput.files[0]);
            filter = new Tone.Filter(20000, "lowpass").toDestination();
            panner = new Tone.Panner(0).connect(filter);
            player = new Tone.Player(url).connect(panner);
            document.getElementById('ui').style.display = 'none';
            initAI();
        }

        function initAI() {
            const pose = new Pose({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`});
            pose.setOptions({ modelComplexity: 0, minDetectionConfidence: 0.5 });
            pose.onResults(onResults);
            new Camera(video, { onFrame: async () => await pose.send({image: video}), width: 480, height: 640 }).start();
        }

        function onResults(results) {
            canvas.width = window.innerWidth; canvas.height = window.innerHeight;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            if (!results.poseLandmarks) return;
            const lm = results.poseLandmarks;

            // 1. BATUTA MATEMÁTICA
            const wrist = { x: lm[16].x * canvas.width, y: lm[16].y * canvas.height };
            const index = { x: lm[20].x * canvas.width, y: lm[20].y * canvas.height };
            ctx.beginPath(); ctx.moveTo(wrist.x, wrist.y);
            ctx.lineTo(wrist.x + (index.x - wrist.x) * 2.5, wrist.y + (index.y - wrist.y) * 2.5);
            ctx.strokeStyle = "white"; ctx.lineWidth = Math.max(2, 6 * (1 - lm[20].z)); ctx.stroke();

            // 2. ANÁLISIS DE AMPLITUD E INTENSIDAD
            path.push({x: lm[20].x, y: lm[20].y}); if (path.length > 20) path.shift();
            const minX = Math.min(...path.map(p => p.x)), maxX = Math.max(...path.map(p => p.x));
            const minY = Math.min(...path.map(p => p.y)), maxY = Math.max(...path.map(p => p.y));
            const amp = (maxX - minX) + (maxY - minY);

            const velocity = Math.hypot(lm[20].x - lastPos.x, lm[20].y - lastPos.y) * 100;

            if (velocity > 0.6) {
                energy = Math.min(100, energy + 1.5);
                if (!isPlaying && player.loaded) { player.start(); isPlaying = true; }
                
                // Algoritmo de expresión: Amp controla Vol y Filtro
                player.volume.rampTo(Math.min(0, Tone.gainToDb(amp * 1.5) - 10), 0.2);
                filter.frequency.rampTo(200 + (amp * 8000), 0.3);
                player.playbackRate = 0.7 + (velocity / 12);
                panner.pan.rampTo((lm[20].x * 2) - 1, 0.1);

                if (velocity > 5 && navigator.vibrate) navigator.vibrate(15); // Haptic
                document.getElementById('hud').innerText = amp > 0.4 ? "DINÁMICA: FORTE" : "DINÁMICA: PIANO";
            } else {
                energy = Math.max(0, energy - 2);
            }

            // FRENO EN SECO
            if (energy <= 0 && isPlaying) { player.stop(); isPlaying = false; document.getElementById('hud').innerText = "DETENIDO"; }
            energyFill.style.width = energy + "%";

            // ATRIL CON AUTO-CALIBRACIÓN
            const tilt = (lm[11].y - lm[12].y) * 0.5;
            ctx.save(); ctx.translate(canvas.width/2, canvas.height - 120); ctx.rotate(tilt);
            ctx.strokeStyle = "#00ffea"; ctx.strokeRect(-100, -30, 200, 60); ctx.restore();

            lastPos = {x: lm[20].x, y: lm[20].y};
        }
    </script>
</body>
</html>
