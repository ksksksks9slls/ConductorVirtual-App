<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>AI Maestro 9.0 - Hard Stop Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #000; overflow: hidden; font-family: 'Segoe UI', sans-serif; color: white; }
        .input_video { position: fixed; width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); z-index: 0; opacity: 0.3; }
        .output_canvas { position: fixed; width: 100%; height: 100%; z-index: 1; transform: scaleX(-1); pointer-events: none; }
        #ui-layer { position: fixed; inset: 0; z-index: 10; display: flex; flex-direction: column; justify-content: center; align-items: center; background: rgba(0,0,0,0.95); text-align: center; }
        .panel { background: #1a1a1a; padding: 40px; border-radius: 25px; border: 1px solid #00ffea; width: 420px; }
        .btn { padding: 15px 30px; background: #00ffea; color: #000; border: none; border-radius: 50px; font-weight: bold; cursor: pointer; margin: 10px; width: 85%; text-transform: uppercase; }
        #status-msg { margin-top: 20px; color: #00ffea; font-family: monospace; }
        #tempo-hud { position: fixed; top: 30px; right: 30px; font-size: 2.5em; color: #00ffea; z-index: 5; display: none; text-shadow: 0 0 10px #00ffea; }
        #stop-warning { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #ff0055; font-size: 3em; font-weight: bold; display: none; z-index: 100; border: 4px solid #ff0055; padding: 20px; }
    </style>
</head>
<body>

    <video class="input_video" playsinline muted></video>
    <canvas class="output_canvas"></canvas>
    <div id="tempo-hud">100%</div>
    <div id="stop-warning">¡PARADA SECA!</div>

    <div id="ui-layer">
        <div id="panel-content" class="panel">
            <h1 id="title" style="color:#00ffea">MAESTRO 9.0</h1>
            <p id="desc">Sube tu música para comenzar la calibración del cuerpo.</p>
            <input type="file" id="audio-input" accept="audio/*" style="display:none">
            <div id="actions"><button class="btn" onclick="document.getElementById('audio-input').click()">SUBIR MÚSICA</button></div>
            <div id="status-msg">ESPERANDO AUDIO...</div>
        </div>
    </div>

    <script>
        const videoElement = document.querySelector('.input_video');
        const canvasElement = document.querySelector('.output_canvas');
        const canvasCtx = canvasElement.getContext('2d');
        const audioInput = document.getElementById('audio-input');
        
        let player, isPlaying = false;
        let pose;
        let flowState = "START"; 
        let calProgress = 0;
        let useBaton = false;
        let currentTempo = 1.0;
        let lastY = 0;
        let inactivityCounter = 0;

        audioInput.onchange = async (e) => {
            const file = e.target.files[0];
            if (file) {
                const url = URL.createObjectURL(file);
                await Tone.start();
                player = new Tone.Player(url).toDestination();
                player.loop = true;
                flowState = "CAL_BODY";
                updateUI();
                initPose();
            }
        };

        function updateUI() {
            const title = document.getElementById('title');
            const desc = document.getElementById('desc');
            const actions = document.getElementById('actions');
            const status = document.getElementById('status-msg');

            if (flowState === "CAL_BODY") {
                title.innerText = "PASO 1: CUERPO";
                desc.innerText = "Quédate quieto frente a la cámara.";
                actions.innerHTML = "";
            } else if (flowState === "CHOOSE_BATON") {
                title.innerText = "¿USARÁS BATUTA?";
                desc.innerText = "La calibración esperará a detectar el objeto.";
                actions.innerHTML = `
                    <button class="btn" onclick="confirmBaton(true)">SÍ, CON BATUTA</button>
                    <button class="btn" style="background:#444; color:white" onclick="confirmBaton(false)">NO, CON MANOS</button>
                `;
            } else if (flowState === "CAL_BATON") {
                title.innerText = "PASO 2: OBJETO";
                desc.innerText = "Sostén el objeto alargado frente a la cámara.";
                actions.innerHTML = "";
            } else if (flowState === "READY") {
                title.innerText = "SISTEMA LISTO";
                desc.innerText = "Cuerpo y batuta vinculados.";
                actions.innerHTML = `<button class="btn" onclick="startConcert()">INICIAR CONCIERTO</button>`;
            }
        }

        function confirmBaton(val) {
            useBaton = val;
            if (useBaton) { flowState = "CAL_BATON"; calProgress = 0; }
            else { flowState = "READY"; }
            updateUI();
        }

        function initPose() {
            pose = new Pose({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`});
            pose.setOptions({ modelComplexity: 1, smoothLandmarks: true, minDetectionConfidence: 0.6 });
            pose.onResults(onResults);
            new Camera(videoElement, { onFrame: async () => { await pose.send({image: videoElement}); }, width: 640, height: 480 }).start();
        }

        function onResults(results) {
            canvasElement.width = window.innerWidth;
            canvasElement.height = window.innerHeight;
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);

            if (results.poseLandmarks) {
                const lm = results.poseLandmarks;
                drawSkeleton(lm);

                if (flowState === "CAL_BODY") {
                    calProgress += 1.5;
                    document.getElementById('status-msg').innerText = `CALIBRANDO CUERPO: ${Math.min(100, Math.round(calProgress))}%`;
                    if (calProgress >= 100) { flowState = "CHOOSE_BATON"; updateUI(); }
                }

                if (flowState === "CAL_BATON") {
                    const dist = Math.hypot(lm[16].x - lm[20].x, lm[16].y - lm[20].y);
                    if (dist > 0.08) { 
                        calProgress += 2;
                        document.getElementById('status-msg').innerText = `CALIBRANDO OBJETO: ${Math.min(100, Math.round(calProgress))}%`;
                        if (calProgress >= 100) { flowState = "READY"; updateUI(); }
                    } else {
                        document.getElementById('status-msg').innerText = "ESPERANDO OBJETO ALARGADO...";
                    }
                }

                if (isPlaying) {
                    const ref = useBaton ? lm[20] : lm[16];
                    const speed = Math.abs(ref.y - lastY) * 100;
                    lastY = ref.y;
                    
                    // LÓGICA DE GOLPE SECO
                    if (speed < 0.08) { // Si el movimiento es casi nulo
                        inactivityCounter++;
                        if (inactivityCounter > 15) { // Aproximadamente 0.5 segundos de quietud
                            player.stop();
                            isPlaying = false;
                            document.getElementById('stop-warning').style.display = 'block';
                            setTimeout(() => { document.getElementById('stop-warning').style.display = 'none'; }, 2000);
                        }
                    } else {
                        inactivityCounter = 0;
                    }

                    if (isPlaying) {
                        let target = Math.min(Math.max(speed / 7, 0.75), 1.8);
                        if (speed < 0.4) target = 1.0;
                        currentTempo = (currentTempo * 0.96) + (target * 0.04);
                        player.playbackRate = currentTempo;
                        document.getElementById('tempo-hud').innerText = Math.round(currentTempo * 100) + "%";
                    }
                }
            }
        }

        function drawSkeleton(lm) {
            canvasCtx.lineWidth = 4;
            canvasCtx.lineCap = "round";
            const p = (i) => ({ x: lm[i].x * canvasElement.width, y: lm[i].y * canvasElement.height });

            // Torso y Cabeza
            canvasCtx.strokeStyle = "rgba(255,255,255,0.4)";
            const neck = { x: (p(11).x + p(12).x)/2, y: (p(11).y + p(12).y)/2 };
            canvasCtx.beginPath();
            canvasCtx.moveTo(p(0).x, p(0).y); canvasCtx.lineTo(neck.x, neck.y);
            canvasCtx.lineTo((p(23).x + p(24).x)/2, (p(23).y + p(24).y)/2);
            canvasCtx.stroke();

            // Brazos
            canvasCtx.strokeStyle = "#00ffea";
            canvasCtx.beginPath();
            canvasCtx.moveTo(p(15).x, p(15).y); canvasCtx.lineTo(p(13).x, p(13).y);
            canvasCtx.lineTo(p(11).x, p(11).y); canvasCtx.lineTo(p(12).x, p(12).y);
            canvasCtx.lineTo(p(14).x, p(14).y); canvasCtx.lineTo(p(16).x, p(16).y);
            canvasCtx.stroke();

            // HUESO DE BATUTA DINÁMICO
            if (useBaton && (flowState === "CAL_BATON" || isPlaying)) {
                canvasCtx.strokeStyle = "#ff0055";
                canvasCtx.lineWidth = 6;
                canvasCtx.beginPath();
                canvasCtx.moveTo(p(16).x, p(16).y);
                canvasCtx.lineTo(p(20).x, p(20).y);
                canvasCtx.stroke();
                canvasCtx.fillStyle = "white";
                canvasCtx.beginPath(); canvasCtx.arc(p(20).x, p(20).y, 6, 0, 7); canvasCtx.fill();
            }
        }

        function startConcert() {
            document.getElementById('ui-layer').style.display = 'none';
            document.getElementById('tempo-hud').style.display = 'block';
            player.start();
            isPlaying = true;
        }
    </script>
</body>
</html>
