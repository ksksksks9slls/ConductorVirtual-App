
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MAESTRO MOBILE</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>

    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: black; color: white; font-family: serif; overflow: hidden; }
        .pantalla { display: none; position: absolute; width: 100%; height: 100%; flex-direction: column; justify-content: center; align-items: center; z-index: 10; }
        .activa { display: flex !important; }
        
        /* Video y Canvas ajustados a pantalla completa sin deformar */
        video, canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        
        /* UI principal */
        h1 { font-size: 3rem; letter-spacing: 10px; text-align: center; }
        button { background: white; color: black; border: none; padding: 20px 40px; font-size: 1.2rem; cursor: pointer; border-radius: 50px; z-index: 100; font-weight: bold; }
        
        #mensaje-flotante { position: absolute; top: 20%; z-index: 100; background: rgba(0,0,0,0.8); padding: 15px; border-radius: 10px; text-align: center; width: 80%; }
        
        /* Flechas de juego grandes y centradas */
        .flecha {
            position: absolute; font-size: 120px; color: #ffff00; z-index: 200;
            top: 50%; left: 50%; transform: translate(-50%, -50%);
            text-shadow: 0 0 30px #ffa500; pointer-events: none;
            animation: anim-flecha 1s ease-out forwards;
        }

        @keyframes anim-flecha {
            0% { transform: translate(-50%, -50%) scale(0.3); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1.5); opacity: 0; }
        }
        
        #cuenta-atras { font-size: 6rem; font-weight: bold; z-index: 150; }
    </style>
</head>
<body>

    <div id="p-inicio" class="pantalla activa">
        <h1>MAESTRO</h1>
        <button onclick="iniciarApp()">JUGAR</button>
    </div>

    <div id="p-escaneo" class="pantalla">
        <video id="v-escaneo" autoplay playsinline style="opacity: 0.8;"></video>
        <canvas id="c-escaneo"></canvas>
        <div id="mensaje-flotante">
            <h2 id="status">Analizando cuerpo...</h2>
            <div id="controles-scan" style="display:none;">
                <p>¿Esqueleto bien puesto?</p>
                <button onclick="irACanciones()">SÍ</button>
                <button onclick="location.reload()" style="background:#444; color:white; margin-top:10px;">REPETIR</button>
            </div>
        </div>
    </div>

    <div id="p-canciones" class="pantalla">
        <h1>OBRAS</h1>
        <button onclick="empezarJuego('toreadores')" style="margin:10px;">Les Toréadors</button>
        <button onclick="empezarJuego('novena')" style="margin:10px;">Sinfonía No. 9</button>
    </div>

    <div id="p-juego" class="pantalla">
        <video id="v-juego" autoplay playsinline style="opacity: 0.8;"></video>
        <canvas id="c-juego"></canvas>
        <div id="cuenta-atras"></div>
        <div id="f-contenedor"></div>
    </div>

    <script>
        let stream, pose, hands, audioCtx;
        let progreso = 0;

        function nav(id) {
            document.querySelectorAll('.pantalla').forEach(p => p.classList.remove('activa'));
            document.getElementById(id).classList.add('activa');
        }

        async function iniciarApp() {
            // Activar AudioContext por interacción del usuario (obligatorio para navegadores)
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            nav('p-escaneo');
            
            try {
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "user", width: { ideal: 640 }, height: { ideal: 480 } } 
                });
                const v = document.getElementById('v-escaneo');
                v.srcObject = stream;
                v.onloadedmetadata = () => {
                    const c = document.getElementById('c-escaneo');
                    c.width = v.videoWidth; c.height = v.videoHeight;
                    configurarEscaneo(v, c);
                };
            } catch (e) { alert("Activa la cámara para jugar"); }
        }

        function configurarEscaneo(v, c) {
            const ctx = c.getContext('2d');
            pose = new Pose({locateFile: (f) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${f}`});
            pose.setOptions({modelComplexity: 1, smoothLandmarks: true});
            
            pose.onResults(res => {
                ctx.clearRect(0, 0, c.width, c.height);
                if (res.poseLandmarks) {
                    ctx.strokeStyle = "white"; ctx.lineWidth = 6;
                    // Dibujado progresivo visible
                    if(progreso > 20) dibujarHuesos(ctx, res.poseLandmarks, [[0,1]]); // Cabeza
                    if(progreso > 50) dibujarHuesos(ctx, res.poseLandmarks, [[11,12], [11,13], [12,14]]); // Torso
                    if(progreso > 80) dibujarHuesos(ctx, res.poseLandmarks, [[13,15], [14,16]]); // Brazos
                }
            });

            let t = setInterval(() => {
                progreso += 5;
                pose.send({image: v});
                document.getElementById('status').innerText = `Analizando... ${progreso}%`;
                if(progreso >= 100) {
                    clearInterval(t);
                    document.getElementById('status').style.display = 'none';
                    document.getElementById('controles-scan').style.display = 'block';
                }
            }, 150);
        }

        function dibujarHuesos(ctx, lms, conexiones) {
            conexiones.forEach(c => {
                const p1 = lms[c[0]], p2 = lms[c[1]];
                ctx.beginPath();
                ctx.moveTo(p1.x * ctx.canvas.width, p1.y * ctx.canvas.height);
                ctx.lineTo(p2.x * ctx.canvas.width, p2.y * ctx.canvas.height);
                ctx.stroke();
            });
        }

        function irACanciones() { nav('p-canciones'); }

        function empezarJuego(obra) {
            nav('p-juego');
            const v = document.getElementById('v-juego');
            v.srcObject = stream;
            const c = document.getElementById('c-juego');
            c.width = v.videoWidth; c.height = v.videoHeight;

            let segs = 3;
            const ct = document.getElementById('cuenta-atras');
            const interval = setInterval(() => {
                ct.innerText = segs;
                if(segs <= 0) {
                    clearInterval(interval);
                    ct.style.display = 'none';
                    motorRitmo(v, c);
                }
                segs--;
            }, 1000);
        }

        function motorRitmo(v, c) {
            const ctx = c.getContext('2d');
            hands = new Hands({locateFile: (f) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`});
            hands.setOptions({maxNumHands: 2, minDetectionConfidence: 0.5});
            
            hands.onResults(res => {
                ctx.clearRect(0,0,c.width, c.height);
                if(res.multiHandLandmarks) {
                    res.multiHandLandmarks.forEach(lm => {
                        dibujarHuesos(ctx, lm, [[0,1],[1,2],[2,3],[3,4]]); // Dibujar mano simple
                    });
                }
            });

            setInterval(() => hands.send({image: v}), 60);
            
            // Ciclo de flechas y música
            setInterval(() => {
                lanzarFlecha();
                sonar();
            }, 1200);
        }

        function sonar() {
            const osc = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            osc.connect(g); g.connect(audioCtx.destination);
            osc.frequency.value = 330; 
            g.gain.setValueAtTime(0.1, audioCtx.currentTime);
            osc.start(); 
            g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.4);
            osc.stop(audioCtx.currentTime + 0.4);
        }

        function lanzarFlecha() {
            const cont = document.getElementById('f-contenedor');
            const f = document.createElement('div');
            f.className = 'flecha';
            const d = ['↑', '↓', '←', '→', '↗', '↘'];
            f.innerText = d[Math.floor(Math.random()*d.length)];
            cont.appendChild(f);
            setTimeout(() => f.remove(), 1000);
        }

        function irACanciones() { nav('p-canciones'); }
    </script>
</body>
</html>
