<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Detector 360 - Visi&oacute;n Artificial</title>
    <script async src="https://docs.opencv.org/4.5.4/opencv.js" type="text/javascript"></script>
    <style>
        :root { --p: #1a73e8; --s: #00c853; --bg: #000; }
        body { font-family: sans-serif; background: var(--bg); color: white; margin: 0; overflow: hidden; height: 100vh; }
        
        .screen { display: none; width: 100%; height: 100%; flex-direction: column; align-items: center; justify-content: center; position: absolute; }
        .active { display: flex; }

        .video-box { position: relative; width: 100%; height: 100vh; background: #000; }
        video, canvas { width: 100%; height: 100%; object-fit: cover; position: absolute; }
        
        .controls { position: absolute; bottom: 40px; display: flex; flex-direction: column; gap: 12px; width: 85%; max-width: 320px; z-index: 100; }
        button { padding: 20px; border: none; border-radius: 15px; font-weight: bold; font-size: 1.1rem; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .btn-blue { background: var(--p); color: white; }
        .btn-rec { background: #ff1744; color: white; }
        .btn-detect { background: var(--s); color: white; }
        
        #overlay-info { position: absolute; top: 30px; background: rgba(0,0,0,0.7); padding: 12px 20px; border-radius: 25px; z-index: 110; font-size: 1rem; border: 1px solid #444; }
        .progress-bar { width: 100%; height: 8px; background: #333; border-radius: 4px; margin-top: 10px; overflow: hidden; display: none; }
        #progress-fill { width: 0%; height: 100%; background: var(--s); transition: width 0.1s; }
    </style>
</head>
<body>

    <div id="overlay-info">Cargando Sistema Inteligente...</div>

    <div id="cam-area" class="video-box" style="display:none;">
        <video id="mainVideo" autoplay playsinline muted></video>
        <canvas id="mainCanvas"></canvas>
    </div>

    <div id="menu" class="screen active">
        <h1 style="margin-bottom: 30px;">DETECTOR 360&deg;</h1>
        <div class="controls">
            <button class="btn-blue" onclick="startApp('scan')">ESCANEAR OBJETO (360&deg;)</button>
            <button id="runBtn" style="background:#444; color:#888;" onclick="startApp('detect')" disabled>INICIAR DETECCI&Oacute;N</button>
        </div>
    </div>

    <div id="scan" class="screen">
        <div class="progress-bar" id="bar"><div id="progress-fill"></div></div>
        <div class="controls">
            <button id="btnRec" class="btn-rec" onclick="start360Scan()">INICIAR ESCANEO 5s</button>
            <button onclick="location.reload()" style="background:#555; color:white;">CANCELAR</button>
        </div>
    </div>

    <div id="detect" class="screen">
        <div class="controls">
            <button style="background:#ff1744; color:white;" onclick="location.reload()">DETENER SISTEMA</button>
        </div>
    </div>

<script>
    let stream = null;
    let samples = [];
    let hsvRange = { min: null, max: null };
    let isLive = false;

    var Module = { onRuntimeInitialized: () => { 
        document.getElementById('overlay-info').innerText = "Listo para Escanear";
    }};

    async function startApp(mode) {
        document.getElementById('menu').classList.remove('active');
        document.getElementById('cam-area').style.display = 'block';
        document.getElementById(mode).classList.add('active');

        if (!stream) {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "environment", width: {ideal: 640} } 
                });
                const v = document.getElementById('mainVideo');
                v.srcObject = stream;
                await v.play();
            } catch (e) { alert("Error: " + e.message); }
        }

        if (mode === 'detect') {
            isLive = true;
            detectionLoop();
        }
    }

    function start360Scan() {
        const btn = document.getElementById('btnRec');
        const bar = document.getElementById('bar');
        const fill = document.getElementById('progress-fill');
        const info = document.getElementById('overlay-info');
        
        btn.disabled = true;
        btn.innerText = "GRABANDO...";
        bar.style.display = 'block';
        samples = [];
        
        let timeLeft = 100;
        let interval = setInterval(() => {
            timeLeft -= 2;
            fill.style.width = (100 - timeLeft) + "%";
            info.innerText = "Rote el objeto lentamente...";
            
            // Capturar color actual en cada frame del intervalo
            captureColorFrame();

            if (timeLeft <= 0) {
                clearInterval(interval);
                process360Data();
            }
        }, 100); // 5 segundos de escaneo (50 muestras)
    }

    function captureColorFrame() {
        const v = document.getElementById('mainVideo');
        const c = document.createElement('canvas');
        c.width = 100; c.height = 100;
        const ctx = c.getContext('2d');
        // Capturamos solo el centro para precisi&oacute;n
        ctx.drawImage(v, v.videoWidth*0.4, v.videoHeight*0.4, v.videoWidth*0.2, v.videoHeight*0.2, 0, 0, 100, 100);
        const d = ctx.getImageData(0,0,100,100).data;
        
        let r=0, g=0, b=0;
        for(let i=0; i<d.length; i+=4) { r+=d[i]; g+=d[i+1]; b+=d[i+2]; }
        samples.push(rgbToHsv(r/(d.length/4), g/(d.length/4), b/(d.length/4)));
    }

    function process360Data() {
        const h = samples.map(p => p[0]), s = samples.map(p => p[1]), v = samples.map(p => p[2]);
        // Calculamos un rango que cubra todas las variaciones de luz del video 360
        hsvRange.min = [Math.min(...h)-10, Math.max(0, Math.min(...s)-60), Math.max(0, Math.min(...v)-60)];
        hsvRange.max = [Math.max(...h)+10, 255, 255];

        document.getElementById('scan').classList.remove('active');
        document.getElementById('cam-area').style.display = 'none';
        document.getElementById('menu').classList.add('active');
        
        const runBtn = document.getElementById('runBtn');
        runBtn.disabled = false;
        runBtn.classList.add('btn-detect');
        document.getElementById('overlay-info').innerText = "Objeto Calibrado 360&deg;";
        alert("Â¡Escaneo completo! El sistema ya conoce todos los &aacute;ngulos del objeto.");
    }

    function detectionLoop() {
        if(!isLive) return;
        const v = document.getElementById('mainVideo');
        const c = document.getElementById('mainCanvas');
        const ctx = c.getContext('2d');
        const cap = new cv.VideoCapture(v);
        
        let src = new cv.Mat(v.videoHeight, v.videoWidth, cv.CV_8UC4);
        let hsv = new cv.Mat(), mask = new cv.Mat();

        function process() {
            if(!isLive) { src.delete(); hsv.delete(); mask.delete(); return; }
            cap.read(src);
            c.width = v.videoWidth; c.height = v.videoHeight;
            
            cv.cvtColor(src, hsv, cv.COLOR_RGBA2RGB);
            cv.cvtColor(hsv, hsv, cv.COLOR_RGB2HSV);
            let low = new cv.Mat(hsv.rows, hsv.cols, hsv.type(), [...hsvRange.min, 0]);
            let high = new cv.Mat(hsv.rows, hsv.cols, hsv.type(), [...hsvRange.max, 255]);
            cv.inRange(hsv, low, high, mask);
            
            let cnts = new cv.MatVector(), hi = new cv.Mat();
            cv.findContours(mask, cnts, hi, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);
            
            ctx.drawImage(v, 0, 0, c.width, c.height);

            let maxA = 0, target = null;
            for(let i=0; i<cnts.size(); i++) {
                let r = cv.boundingRect(cnts.get(i));
                let a = r.width * r.height;
                if(a > maxA && r.width > 25) { maxA = a; target = r; }
            }

            if(target) {
                const x = target.x + target.width/2;
                const y = target.y + target.height/2;
                // Dibujar Flecha de Seguimiento
                ctx.fillStyle = "#00FF00"; ctx.strokeStyle = "#00FF00"; ctx.lineWidth = 5;
                ctx.beginPath(); ctx.moveTo(x, y+50); ctx.lineTo(x, y+15); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(x-15, y+30); ctx.lineTo(x, y+10); ctx.lineTo(x+15, y+30); ctx.fill();
                ctx.strokeRect(x-40, y-40, 80, 80);
            }
            low.delete(); high.delete(); cnts.delete(); hi.delete();
            requestAnimationFrame(process);
        }
        process();
    }

    function rgbToHsv(r, g, b) {
        r /= 255, g /= 255, b /= 255;
        let max = Math.max(r, g, b), min = Math.min(r, g, b), d = max - min, h, s, v = max;
        s = max === 0 ? 0 : d / max;
        if (max === min) h = 0;
        else {
            if(max === r) h = (g - b) / d + (g < b ? 6 : 0);
            else if(max === g) h = (b - r) / d + 2;
            else h = (r - g) / d + 4;
            h /= 6;
        }
        return [h * 180, s * 255, v * 255];
    }
</script>
</body>
</html>
