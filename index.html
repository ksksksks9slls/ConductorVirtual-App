<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Maestro 7.0 - Baton Edition</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>

    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #000; overflow: hidden; font-family: 'Segoe UI', sans-serif; color: white; }
        .input_video { position: fixed; width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); z-index: 0; opacity: 0.3; filter: contrast(1.2); }
        .output_canvas { position: fixed; width: 100%; height: 100%; z-index: 1; transform: scaleX(-1); pointer-events: none; }
        
        #ui-layer { position: fixed; inset: 0; z-index: 10; display: flex; flex-direction: column; justify-content: center; align-items: center; background: rgba(0,0,0,0.9); transition: 0.5s; text-align: center; }
        .panel { background: rgba(30,30,30,0.9); padding: 40px; border-radius: 30px; border: 2px solid #00ffea; max-width: 85%; }
        .btn { padding: 15px 35px; background: #00ffea; color: black; border: none; border-radius: 50px; font-weight: bold; cursor: pointer; font-size: 1.1em; margin: 10px; text-transform: uppercase; transition: 0.3s; }
        .btn-alt { background: transparent; color: #00ffea; border: 2px solid #00ffea; }
        
        #tempo-display { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 5; background: rgba(0,255,234,0.2); padding: 10px 30px; border-radius: 20px; border: 1px solid #00ffea; font-family: monospace; font-size: 1.5em; color: #00ffea; display: none; }
        #cal-progress { width: 300px; height: 10px; background: #222; border-radius: 5px; margin-top: 20px; overflow: hidden; display: none; }
        #cal-bar { width: 0%; height: 100%; background: #00ffea; }
    </style>
</head>
<body>

    <video class="input_video" playsinline muted></video>
    <canvas class="output_canvas"></canvas>
    
    <div id="tempo-display">TEMPO: 100%</div>

    <div id="ui-layer">
        <div id="step-audio" class="panel">
            <h1 style="color:#00ffea">MAESTRO PRO 7.0</h1>
            <p>Selecciona tu obra musical</p>
            <input type="file" id="audio-input" accept="audio/*" style="display:none">
            <button class="btn" onclick="document.getElementById('audio-input').click()">SUBIR MÚSICA</button>
        </div>

        <div id="step-baton" class="panel" style="display:none">
            <h2>¿USARÁS BATUTA?</h2>
            <p>Puedes usar un lápiz, palillo o batuta real para mayor precisión.</p>
            <button class="btn" onclick="setBaton(true)">SÍ, USAR BATUTA</button>
            <button class="btn btn-alt" onclick="setBaton(false)">NO, USAR MANO</button>
        </div>

        <div id="step-cal" class="panel" style="display:none">
            <h2 id="cal-title">CALIBRANDO CUERPO</h2>
            <p id="cal-text">Mantente visible para la cámara...</p>
            <div id="cal-progress" style="display:block"><div id="cal-bar"></div></div>
        </div>

        <div id="step-ready" class="panel" style="display:none">
            <h2 style="color:#00ffea">SISTEMA CONFIGURADO</h2>
            <button class="btn" onclick="finalStart()">COMENZAR CONCIERTO</button>
        </div>
    </div>

    <script>
        const videoElement = document.querySelector('.input_video');
        const canvasElement = document.querySelector('.output_canvas');
        const canvasCtx = canvasElement.getContext('2d');
        const audioInput = document.getElementById('audio-input');
        
        let player, isPlaying = false;
        let pose;
        let useBaton = false;
        let calState = 0; // 0: audio, 1: baton?, 2: cal body, 3: cal baton, 4: ready
        let calProgress = 0;
        let orchestratorTempo = 1.0;
        let lastRefY = 0;

        audioInput.onchange = async (e) => {
            const file = e.target.files[0];
            if (file) {
                const url = URL.createObjectURL(file);
                await Tone.start();
                player = new Tone.Player(url).toDestination();
                player.loop = true;
                document.getElementById('step-audio').style.display = 'none';
                document.getElementById('step-baton').style.display = 'block';
            }
        };

        function setBaton(val) {
            useBaton = val;
            document.getElementById('step-baton').style.display = 'none';
            document.getElementById('step-cal').style.display = 'block';
            calState = 2; // Iniciar calibración de cuerpo
            initPose();
        }

        function initPose() {
            pose = new Pose({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`});
            pose.setOptions({ modelComplexity: 1, smoothLandmarks: true, minDetectionConfidence: 0.6 });
            pose.onResults(onResults);

            new Camera(videoElement, {
                onFrame: async () => { await pose.send({image: videoElement}); },
                width: 640, height: 480
            }).start();
        }

        function onResults(results) {
            canvasElement.width = window.innerWidth;
            canvasElement.height = window.innerHeight;
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);

            if (results.poseLandmarks) {
                const lm = results.poseLandmarks;
                drawProSkeleton(lm);
                
                // Lógica de Calibración
                if (calState === 2 || calState === 3) {
                    calProgress += 1.0; 
                    document.getElementById('cal-bar').style.width = (calProgress % 100) + "%";

                    if (calProgress >= 100 && calState === 2) {
                        if (useBaton) {
                            calState = 3;
                            calProgress = 0;
                            document.getElementById('cal-title').innerText = "CALIBRANDO BATUTA";
                            document.getElementById('cal-text').innerText = "Sujeta la batuta firmemente hacia adelante";
                        } else {
                            finishCal();
                        }
                    } else if (calProgress >= 100 && calState === 3) {
                        finishCal();
                    }
                }

                // Lógica de Dirección
                if (isPlaying) {
                    // Si usa batuta, seguimos el dedo índice (punto 20) como punta extendida
                    // Si no, seguimos la muñeca (punto 16)
                    const refPoint = useBaton ? lm[20] : lm[16];
                    const speed = Math.abs(refPoint.y - lastRefY) * 90;
                    lastRefY = refPoint.y;

                    // INERCIA PESADA: Solo reacciona a cambios claros
                    let target = Math.min(Math.max(speed / 7, 0.75), 1.7);
                    if (speed < 0.3) target = 1.0;

                    // Suavizado extremo (96% anterior para realismo)
                    orchestratorTempo = (orchestratorTempo * 0.96) + (target * 0.04);
                    player.playbackRate = orchestratorTempo;
                    
                    document.getElementById('tempo-display').innerText = "TEMPO: " + Math.round(orchestratorTempo * 100) + "%";
                }
            }
        }

        function finishCal() {
            calState = 4;
            document.getElementById('step-cal').style.display = 'none';
            document.getElementById('step-ready').style.display = 'block';
        }

        function drawProSkeleton(lm) {
            canvasCtx.lineWidth = 4;
            canvasCtx.lineCap = "round";
            const p = (i) => ({ x: lm[i].x * canvasElement.width, y: lm[i].y * canvasElement.height });

            const pts = { nose: p(0), lS: p(11), rS: p(12), lE: p(13), rE: p(14), lW: p(15), rW: p(16), lH: p(23), rH: p(24), batonTip: p(20) };

            // 1. Eje Central (Blanco)
            canvasCtx.strokeStyle = "white";
            const neck = { x: (pts.lS.x + pts.rS.x)/2, y: (pts.lS.y + pts.rS.y)/2 };
            const base = { x: (pts.lH.x + pts.rH.x)/2, y: (pts.lH.y + pts.rH.y)/2 };
            canvasCtx.beginPath();
            canvasCtx.moveTo(pts.nose.x, pts.nose.y);
            canvasCtx.lineTo(neck.x, neck.y);
            canvasCtx.lineTo(base.x, base.y);
            canvasCtx.stroke();

            // 2. Brazos y Línea Inter-Codos (Cian)
            canvasCtx.strokeStyle = "#00ffea";
            canvasCtx.beginPath();
            canvasCtx.moveTo(pts.lW.x, pts.lW.y); canvasCtx.lineTo(pts.lE.x, pts.lE.y);
            canvasCtx.lineTo(pts.lS.x, pts.lS.y); canvasCtx.lineTo(pts.rS.x, pts.rS.y);
            canvasCtx.lineTo(pts.rE.x, pts.rE.y); canvasCtx.lineTo(pts.rW.x, pts.rW.y);
            canvasCtx.stroke();

            // Línea de Codos (Discontinua)
            canvasCtx.setLineDash([5, 10]);
            canvasCtx.beginPath();
            canvasCtx.moveTo(pts.lE.x, pts.lE.y); canvasCtx.lineTo(pts.rE.x, pts.rE.y);
            canvasCtx.stroke();
            canvasCtx.setLineDash([]);

            // 3. LA BATUTA (Hueso extra si se selecciona)
            if (useBaton) {
                canvasCtx.strokeStyle = "#ff0055"; // Color batuta para destacar
                canvasCtx.lineWidth = 6;
                canvasCtx.beginPath();
                canvasCtx.moveTo(pts.rW.x, pts.rW.y);
                canvasCtx.lineTo(pts.batonTip.x, pts.batonTip.y); // Extensión del índice como batuta
                canvasCtx.stroke();
                
                // Brillo en la punta
                canvasCtx.fillStyle = "white";
                canvasCtx.beginPath();
                canvasCtx.arc(pts.batonTip.x, pts.batonTip.y, 5, 0, Math.PI*2);
                canvasCtx.fill();
            }

            // Punto Cabeza
            canvasCtx.fillStyle = "#00ffea";
            canvasCtx.beginPath();
            canvasCtx.arc(pts.nose.x, pts.nose.y, 10, 0, Math.PI*2);
            canvasCtx.fill();
        }

        function finalStart() {
            document.getElementById('ui-layer').style.display = 'none';
            document.getElementById('tempo-display').style.display = 'block';
            player.start();
            isPlaying = true;
        }
    </script>
</body>
</html>
