<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Maestro 5.0 - Calibración Avanzada</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>

    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #000; overflow: hidden; font-family: 'Segoe UI', sans-serif; color: white; }
        .input_video { position: fixed; width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); z-index: 0; filter: brightness(1.2); }
        .output_canvas { position: fixed; width: 100%; height: 100%; z-index: 1; transform: scaleX(-1); pointer-events: none; }
        
        /* Interfaz de Usuario */
        #overlay { position: fixed; inset: 0; z-index: 10; display: flex; flex-direction: column; justify-content: center; align-items: center; background: rgba(0,0,0,0.85); transition: 0.5s; }
        #calibration-guide { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 250px; height: 450px; border: 3px dashed #00ffea; border-radius: 50px; z-index: 5; display: none; }
        
        .panel { background: rgba(20, 20, 20, 0.9); padding: 30px; border-radius: 20px; border: 1px solid #00ffea; text-align: center; max-width: 80%; }
        .btn { padding: 15px 30px; background: #00ffea; color: black; border: none; border-radius: 50px; font-weight: bold; cursor: pointer; font-size: 1.1em; margin-top: 20px; text-transform: uppercase; }
        
        #countdown { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 15vw; color: #00ffea; z-index: 20; display: none; text-shadow: 0 0 30px #00ffea; }
        #hud { position: fixed; top: 20px; left: 20px; z-index: 5; display: none; font-family: monospace; }
    </style>
</head>
<body>

    <video class="input_video" playsinline muted></video>
    <canvas class="output_canvas"></canvas>
    <div id="calibration-guide"></div>
    <div id="countdown">3</div>

    <div id="hud">
        <div style="color: #00ffea; font-size: 1.5em;">MAESTRO ACTIVO</div>
        <div id="info-tempo">Tempo: 100%</div>
    </div>

    <div id="overlay">
        <div id="step-upload" class="panel">
            <h1>MAESTRO PRO 5.0</h1>
            <p>Primero, selecciona la pieza musical que vas a dirigir.</p>
            <input type="file" id="audio-file" accept="audio/*" style="display:none">
            <button class="btn" onclick="document.getElementById('audio-file').click()">SUBIR MÚSICA</button>
        </div>

        <div id="step-calibrate" class="panel" style="display:none">
            <h2 id="cal-title">CALIBRACIÓN: FRENTE</h2>
            <p id="cal-desc">Ponte frente a la cámara mostrando tus manos.</p>
            <div id="cal-progress" style="width: 100%; height: 10px; background: #333; margin-top: 10px;"><div id="cal-bar" style="width: 0%; height: 100%; background: #00ffea;"></div></div>
        </div>

        <div id="step-ready" class="panel" style="display:none">
            <h2>SISTEMA CALIBRADO</h2>
            <p>El esqueleto y los dedos han sido identificados correctamente.</p>
            <button class="btn" onclick="startCountdown()">EMPEZAR A DIRIGIR</button>
        </div>
    </div>

    <script>
        const videoElement = document.querySelector('.input_video');
        const canvasElement = document.querySelector('.output_canvas');
        const canvasCtx = canvasElement.getContext('2d');
        const audioInput = document.getElementById('audio-file');
        
        let player, isPlaying = false;
        let pose, hands;
        let calibration = 0; // 0: frente, 1: espalda, 2: listo
        let calPercent = 0;
        let smoothRate = 1.0;
        let lastWristPos = null;

        // 1. CARGA DE AUDIO
        audioInput.onchange = async (e) => {
            const file = e.target.files[0];
            if (file) {
                const url = URL.createObjectURL(file);
                await Tone.start();
                player = new Tone.Player(url).toDestination();
                player.loop = true;
                
                document.getElementById('step-upload').style.display = 'none';
                document.getElementById('step-calibrate').style.display = 'block';
                document.getElementById('calibration-guide').style.display = 'block';
                initModels();
            }
        };

        // 2. INICIALIZAR MODELOS (HUESOS + DEDOS)
        function initModels() {
            pose = new Pose({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`});
            pose.setOptions({ modelComplexity: 1, smoothLandmarks: true });
            pose.onResults(onPoseResults);

            hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
            hands.setOptions({ maxNumHands: 2, modelComplexity: 1, minDetectionConfidence: 0.7 });
            hands.onResults(onHandResults);

            const camera = new Camera(videoElement, {
                onFrame: async () => {
                    await pose.send({image: videoElement});
                    await hands.send({image: videoElement});
                },
                width: 640, height: 480
            });
            camera.start();
        }

        let currentPoseLandmarks = null;
        let currentHandLandmarks = null;

        function onPoseResults(results) { currentPoseLandmarks = results.poseLandmarks; runLogic(); }
        function onHandResults(results) { currentHandLandmarks = results.multiHandLandmarks; }

        function runLogic() {
            canvasElement.width = window.innerWidth;
            canvasElement.height = window.innerHeight;
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);

            if (currentPoseLandmarks) {
                drawFullSkeleton(currentPoseLandmarks, currentHandLandmarks);
                
                // Lógica de calibración
                if (calibration < 2) {
                    calPercent += 0.5;
                    document.getElementById('cal-bar').style.width = calPercent + "%";
                    
                    if (calPercent >= 100) {
                        if (calibration === 0) {
                            calibration = 1;
                            calPercent = 0;
                            document.getElementById('cal-title').innerText = "CALIBRACIÓN: ESPALDA";
                            document.getElementById('cal-desc').innerText = "Gira y mantente un momento de espaldas.";
                        } else {
                            calibration = 2;
                            document.getElementById('step-calibrate').style.display = 'none';
                            document.getElementById('step-ready').style.display = 'block';
                            document.getElementById('calibration-guide').style.display = 'none';
                        }
                    }
                }

                // Lógica de dirección (si ya empezó)
                if (isPlaying) {
                    const wrist = currentPoseLandmarks[16]; // Muñeca derecha
                    const x = wrist.x * canvasElement.width;
                    const y = wrist.y * canvasElement.height;
                    
                    if (lastWristPos) {
                        const dist = Math.sqrt(Math.pow(x-lastWristPos.x, 2) + Math.pow(y-lastWristPos.y, 2));
                        let target = Math.min(Math.max(dist / 12, 0.6), 2.0);
                        if (dist < 2) target = 1.0;
                        smoothRate = (smoothRate * 0.92) + (target * 0.08);
                    }
                    lastWristPos = {x, y};
                    player.playbackRate = smoothRate;
                    document.getElementById('info-tempo').innerText = "Tempo: " + Math.round(smoothRate * 100) + "%";
                }
            }
        }

        function drawFullSkeleton(poseLM, handsLM) {
            canvasCtx.lineWidth = 4;
            canvasCtx.lineCap = "round";

            // 1. Punto en Cabeza y Cuello
            const nose = poseLM[0];
            const lShoulder = poseLM[11];
            const rShoulder = poseLM[12];
            const neckX = (lShoulder.x + rShoulder.x) / 2;
            const neckY = (lShoulder.y + rShoulder.y) / 2;

            // Cabeza
            canvasCtx.fillStyle = "#00ffea";
            canvasCtx.beginPath();
            canvasCtx.arc(nose.x * canvasElement.width, nose.y * canvasElement.height, 10, 0, 2*Math.PI);
            canvasCtx.fill();

            // Torso (Líneas Hombros a Cuello)
            canvasCtx.strokeStyle = "#ffffff";
            canvasCtx.beginPath();
            canvasCtx.moveTo(lShoulder.x * canvasElement.width, lShoulder.y * canvasElement.height);
            canvasCtx.lineTo(neckX * canvasElement.width, neckY * canvasElement.height);
            canvasCtx.lineTo(rShoulder.x * canvasElement.width, rShoulder.y * canvasElement.height);
            canvasCtx.stroke();

            // 2. Brazos
            canvasCtx.strokeStyle = "#00ffea";
            [[12, 14], [14, 16], [11, 13], [13, 15]].forEach(([i, j]) => {
                canvasCtx.beginPath();
                canvasCtx.moveTo(poseLM[i].x * canvasElement.width, poseLM[i].y * canvasElement.height);
                canvasCtx.lineTo(poseLM[j].x * canvasElement.width, poseLM[j].y * canvasElement.height);
                canvasCtx.stroke();
            });

            // 3. Dedos (Mini líneas)
            if (handsLM) {
                canvasCtx.strokeStyle = "#ff0055";
                canvasCtx.lineWidth = 2;
                handsLM.forEach(hand => {
                    // Dibujar cada dedo
                    for (let f = 0; f < 5; f++) {
                        canvasCtx.beginPath();
                        let base = 0; // Palma
                        for (let pt = 1; pt <= 4; pt++) {
                            let idx = f * 4 + pt;
                            let start = hand[base];
                            let end = hand[idx];
                            canvasCtx.moveTo(start.x * canvasElement.width, start.y * canvasElement.height);
                            canvasCtx.lineTo(end.x * canvasElement.width, end.y * canvasElement.height);
                            base = idx;
                        }
                        canvasCtx.stroke();
                    }
                });
            }
        }

        function startCountdown() {
            document.getElementById('overlay').style.display = 'none';
            const cd = document.getElementById('countdown');
            cd.style.display = 'block';
            let count = 3;
            
            const timer = setInterval(() => {
                count--;
                cd.innerText = count;
                if (count <= 0) {
                    clearInterval(timer);
                    cd.style.display = 'none';
                    document.getElementById('hud').style.display = 'block';
                    player.start();
                    isPlaying = true;
                }
            }, 1000);
        }
    </script>
</body>
</html>
