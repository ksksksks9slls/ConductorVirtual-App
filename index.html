<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Maestro AI - Detector de Esqueleto</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>

    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #000; overflow: hidden; font-family: sans-serif; }
        
        .input_video { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            object-fit: cover; transform: scaleX(-1); z-index: 0;
            filter: brightness(1.2) contrast(1.2);
        }

        .output_canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; transform: scaleX(-1); pointer-events: none; }
        
        /* Guía visual para calibración */
        #guideline {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 60vh; height: 80vh; border: 4px dashed rgba(0, 255, 234, 0.3);
            border-radius: 50px; z-index: 1; display: flex; align-items: center; justify-content: center;
        }

        #ui {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 10;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            background: rgba(0,0,0,0.8); color: white; text-align: center;
        }

        .status {
            position: fixed; top: 20px; width: 100%; text-align: center;
            z-index: 5; color: #00ffea; font-family: monospace; font-size: 1.2em;
            background: rgba(0,0,0,0.5); padding: 10px 0;
        }

        #btn-start {
            padding: 20px 40px; background: #00ffea; border: none; border-radius: 50px;
            font-size: 1.2em; font-weight: bold; cursor: pointer; box-shadow: 0 0 20px #00ffea;
        }
    </style>
</head>
<body>

    <video class="input_video" playsinline muted></video>
    <canvas class="output_canvas"></canvas>
    
    <div id="guideline"><span style="color:rgba(0,255,234,0.5)">PONTE AQUÍ</span></div>
    
    <div id="status-display" class="status">BUSCANDO CUERPO...</div>

    <div id="ui">
        <h1 style="color:#00ffea">MAESTRO AI 4.0</h1>
        <p>1. Sube tu canción.<br>2. Aléjate de la cámara hasta que veas las líneas azules.<br>3. Mueve tus brazos para sonar.</p>
        <input type="file" id="audio-file" accept="audio/*" style="display:none">
        <button id="btn-start" onclick="document.getElementById('audio-file').click()">SUBIR MÚSICA</button>
    </div>

    <script>
        const videoElement = document.querySelector('.input_video');
        const canvasElement = document.querySelector('.output_canvas');
        const canvasCtx = canvasElement.getContext('2d');
        const audioInput = document.getElementById('audio-file');
        const statusDisplay = document.getElementById('status-display');
        
        let player, isPlaying = false;
        let lastPos = null;
        let smoothRate = 1.0;

        audioInput.onchange = async (e) => {
            const file = e.target.files[0];
            if (file) {
                const url = URL.createObjectURL(file);
                await Tone.start();
                player = new Tone.Player(url).toDestination();
                player.loop = true;
                
                document.getElementById('ui').style.display = 'none';
                startTracking();
            }
        };

        function startTracking() {
            const pose = new Pose({
                locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`
            });

            // CONFIGURACIÓN LITE (Mucho más fácil de detectar)
            pose.setOptions({
                modelComplexity: 0, // 0 = Lite (Rápido), 1 = Full, 2 = Heavy
                smoothLandmarks: true,
                minDetectionConfidence: 0.5,
                minTrackingConfidence: 0.5
            });

            pose.onResults(onResults);

            const camera = new Camera(videoElement, {
                onFrame: async () => { await pose.send({image: videoElement}); },
                width: 640, height: 480
            });
            camera.start();
        }

        function onResults(results) {
            canvasElement.width = window.innerWidth;
            canvasElement.height = window.innerHeight;
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);

            if (results.poseLandmarks) {
                statusDisplay.innerText = "¡CUERPO DETECTADO!";
                statusDisplay.style.color = "#00ffea";
                
                drawBones(results.poseLandmarks);
                
                // Usamos la muñeca derecha (punto 16)
                const wrist = results.poseLandmarks[16];
                const x = wrist.x * canvasElement.width;
                const y = wrist.y * canvasElement.height;

                if (lastPos) {
                    const dist = Math.sqrt(Math.pow(x - lastPos.x, 2) + Math.pow(y - lastPos.y, 2));
                    let target = Math.min(Math.max(dist / 15, 0.6), 2.0);
                    if (dist < 3) target = 1.0;
                    
                    smoothRate = (smoothRate * 0.9) + (target * 0.1);
                }
                lastPos = {x, y};

                if (player && player.loaded) {
                    if (player.state !== "started") player.start();
                    player.playbackRate = smoothRate;
                    statusDisplay.innerText = "ORQUESTA AL " + Math.round(smoothRate * 100) + "%";
                }

            } else {
                statusDisplay.innerText = "BUSCANDO ESQUELETO...";
                statusDisplay.style.color = "#ff0055";
            }
        }

        function drawBones(landmarks) {
            canvasCtx.lineWidth = 8;
            canvasCtx.strokeStyle = "#00ffea";
            canvasCtx.lineCap = "round";

            // Dibujar brazos y hombros
            const connections = [
                [11, 12], [11, 13], [13, 15], // Brazo izquierdo
                [12, 14], [14, 16]            // Brazo derecho
            ];

            connections.forEach(([i, j]) => {
                const a = landmarks[i];
                const b = landmarks[j];
                canvasCtx.beginPath();
                canvasCtx.moveTo(a.x * canvasElement.width, a.y * canvasElement.height);
                canvasCtx.lineTo(b.x * canvasElement.width, b.y * canvasElement.height);
                canvasCtx.stroke();
            });
            
            // Dibujar cabeza
            canvasCtx.beginPath();
            canvasCtx.arc(landmarks[0].x * canvasElement.width, landmarks[0].y * canvasElement.height, 15, 0, 2*Math.PI);
            canvasCtx.fillStyle = "#fff";
            canvasCtx.fill();
        }
    </script>
</body>
</html>
