<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Google Semi-Conductor Recreated - Final V2</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>

    <style>
        /* Reset y diseño base para pantalla completa */
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #000;
            font-family: 'Helvetica Neue', Arial, sans-serif;
        }

        /* CAPA 1: El video de fondo */
        .input_video {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1); /* Efecto espejo */
            z-index: 1;
        }

        /* CAPA 2: El canvas para efectos visuales (transparente) */
        .output_canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
            pointer-events: none; /* Dejar pasar clicks */
            transform: scaleX(-1); /* Efecto espejo para coincidir con el video */
        }

        /* CAPA 3: Interfaz de usuario (UI) */
        #ui-layer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: rgba(0,0,0,0.85);
            color: white;
            transition: opacity 0.8s ease-out;
        }

        #bpm-indicator {
            position: fixed;
            top: 30px;
            right: 30px;
            z-index: 5;
            color: #00ffea;
            font-size: 3em;
            font-weight: 800;
            text-shadow: 0 0 20px rgba(0, 255, 234, 0.7);
            font-variant-numeric: tabular-nums;
            display: none; /* Se muestra al iniciar */
        }

        h1 { font-weight: 200; letter-spacing: 4px; margin-bottom: 10px; text-transform: uppercase; }
        p { color: #ccc; max-width: 600px; text-align: center; line-height: 1.6; margin-bottom: 40px; }

        #start-btn {
            padding: 20px 60px;
            font-size: 22px;
            background: white;
            color: black;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            letter-spacing: 2px;
            transition: all 0.3s;
        }

        #start-btn:hover { background: #00ffea; box-shadow: 0 0 30px #00ffea; transform: scale(1.05); }
        
        #loading-status { margin-top: 20px; font-size: 14px; color: #888; }
        
        /* Estilo para cuando el sistema está listo */
        body.ready #loading-status { color: #00ffea; }
        body.playing #ui-layer { opacity: 0; pointer-events: none; }
        body.playing #bpm-indicator { display: block; }
    </style>
</head>
<body>

    <video class="input_video" playsinline></video>
    <canvas class="output_canvas"></canvas>

    <div id="bpm-indicator">0 BPM</div>

    <div id="ui-layer">
        <h1>Semi-Conductor</h1>
        <p>Tu dedo índice es la batuta. Mueve la mano en arcos amplios para dirigir la orquesta. Cuanto más rápido y amplio sea el movimiento, más rápido tocarán.</p>
        <button id="start-btn" disabled>CARGANDO MODELOS...</button>
        <div id="loading-status">Iniciando visión por computadora...</div>
    </div>


    <script>
        /**
         * CONFIGURACIÓN DE AUDIO PROFESIONAL (Tone.js)
         * Usamos una combinación de sintetizadores para un sonido orquestal más rico.
         */
        
        // Melodía más larga (Fragmento de Mozart - Sinfonía n.º 25)
        const melody = [
            ["G4", "4n"], ["D4", "4n"], ["G4", "4n"], ["D4", "4n"],
            ["G4", "4n"], ["D4", "4n"], ["G4", "4n"], ["D4", "4n"],
            ["Eb4", "2n"], ["D4", "2n"],
            ["Eb4", "2n"], ["D4", "2n"],
            ["G3", "8n"], ["Bb3", "8n"], ["D4", "8n"], ["G4", "8n"], ["Bb4", "2n"],
            ["A4", "4n"], ["G4", "4n"], ["F#4", "2n"]
        ];

        // Instrumento principal: Un sintetizador AMSynth suena más "bronce"
        const leadSynth = new Tone.AMSynth({
            harmonicity: 2.5,
            oscillator: { type: "sawtooth" },
            envelope: { attack: 0.1, decay: 0.2, sustain: 0.5, release: 0.5 },
            modulation: { type: "square" },
            modulationEnvelope: { attack: 0.5, decay: 0, sustain: 1, release: 0.5 }
        }).toDestination();

        // Instrumento secundario para dar cuerpo (cuerdas graves)
        const bassSynth = new Tone.PolySynth(Tone.Synth, {
            oscillator: { type: "triangle" },
            envelope: { attack: 0.2, decay: 0.1, sustain: 0.8, release: 1 }
        }).toDestination();

        // Efectos globales para dar sensación de sala de conciertos
        const reverb = new Tone.Reverb({ decay: 4, wet: 0.4 }).toDestination();
        leadSynth.connect(reverb);
        bassSynth.connect(reverb);
        bassSynth.volume.value = -8; // Bajar volumen del bajo

        let part; // La partitura

        /**
         * VARIABLES DE ESTADO Y LÓGICA
         */
        let isSystemReady = false;
        let isPlaying = false;
        let previousPosition = { x: null, y: null, time: 0 };
        let currentBPM = 0;
        let targetBPM = 0;
        
        // Cola para suavizar el movimiento (evita saltos bruscos)
        const speedHistory = [];
        const HISTORY_SIZE = 5; 

        // Elementos del DOM
        const videoElement = document.getElementsByClassName('input_video')[0];
        const canvasElement = document.getElementsByClassName('output_canvas')[0];
        const canvasCtx = canvasElement.getContext('2d');
        const startBtn = document.getElementById('start-btn');
        const loadingStatus = document.getElementById('loading-status');
        const bpmIndicator = document.getElementById('bpm-indicator');

        /**
         * INICIALIZACIÓN DEL SISTEMA
         */
        function setup() {
            // 1. Configurar Video y Canvas a pantalla completa real
            canvasElement.width = window.innerWidth;
            canvasElement.height = window.innerHeight;

            window.addEventListener('resize', () => {
                canvasElement.width = window.innerWidth;
                canvasElement.height = window.innerHeight;
            });

            // 2. Inicializar MediaPipe Hands
            const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
            
            // Configuración optimizada para velocidad
            hands.setOptions({
                maxNumHands: 1,
                modelComplexity: 0, // 0 es el modelo más rápido (lite)
                minDetectionConfidence: 0.5,
                minTrackingConfidence: 0.5
            });

            hands.onResults(onHandsResults);

            // 3. Iniciar Cámara
            const camera = new Camera(videoElement, {
                onFrame: async () => {
                    // Enviamos el video para procesar, pero NO lo dibujamos en el canvas
                    await hands.send({image: videoElement});
                },
                // Usamos una resolución de entrada moderada para mejorar FPS
                width: 640,
                height: 480
            });
            
            camera.start().then(() => {
                console.log("Cámara iniciada");
                isSystemReady = true;
                document.body.classList.add('ready');
                startBtn.disabled = false;
                startBtn.innerText = "COMENZAR A DIRIGIR";
                loadingStatus.innerText = "Sistema listo. Sube el volumen.";
            });

            setupAudioSequence();
        }

        function setupAudioSequence() {
            part = new Tone.Part((time, noteInfo) => {
                // Tocar nota principal
                leadSynth.triggerAttackRelease(noteInfo[0], noteInfo[1], time);
                // Tocar una octava abajo para el bajo
                const bassNote = Tone.Frequency(noteInfo[0]).transpose(-12);
                bassSynth.triggerAttackRelease(bassNote, noteInfo[1], time);
            }, melody.map((note, index) => [index * 0.5, note])); // Mapear notas al tiempo

            part.loop = true;
            part.loopEnd = melody.length * 0.5;
        }


        /**
         * BUCLE PRINCIPAL DE PROCESAMIENTO (Se ejecuta en cada frame de video)
         */
        function onHandsResults(results) {
            // 1. Limpiar el canvas (para que sea transparente sobre el video)
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);

            if (!isPlaying) return;

            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const landmarks = results.multiHandLandmarks[0];
                
                // Usamos la punta del dedo ÍNDICE (Punto 8) como batuta
                const batonTip = landmarks[8]; 
                
                // Convertir coordenadas normalizadas (0.0-1.0) a píxeles de pantalla
                const screenX = batonTip.x * canvasElement.width;
                const screenY = batonTip.y * canvasElement.height;
                const now = performance.now();

                // --- LÓGICA DE CÁLCULO DE TEMPO ---
                if (previousPosition.x !== null) {
                    const dx = screenX - previousPosition.x;
                    const dy = screenY - previousPosition.y;
                    // Distancia euclidiana (hipotenusa)
                    const distance = Math.sqrt(dx*dx + dy*dy);
                    const dt = now - previousPosition.time;

                    // Velocidad en píxeles por milisegundo
                    const speed = distance / dt;

                    // Calcular BPM objetivo basado en la velocidad
                    // Los factores (50 y 180) son ajustables para la sensibilidad
                    let calculatedBPM = Math.min(Math.max(speed * 150, 0), 220);
                    
                    // Si el movimiento es muy lento, forzar a 0 (parada)
                    if (calculatedBPM < 20) calculatedBPM = 0;

                    // Suavizado: Añadir al historial
                    speedHistory.push(calculatedBPM);
                    if (speedHistory.length > HISTORY_SIZE) speedHistory.shift();
                    
                    // Promedio del historial para el targetBPM
                    targetBPM = speedHistory.reduce((a, b) => a + b, 0) / speedHistory.length;
                }

                // Actualizar posición anterior
                previousPosition = { x: screenX, y: screenY, time: now };

                // --- DIBUJAR EFECTO VISUAL (BATUTA) ---
                drawBatonVisuals(screenX, screenY);

            } else {
                // Si se pierde la mano, bajar el ritmo gradualmente
                targetBPM = 0;
                previousPosition = { x: null, y: null, time: 0 };
            }

            // --- ACTUALIZAR AUDIO BPM (Interpolación suave) ---
            // Acercamos el BPM actual al objetivo un 5% en cada frame
            currentBPM += (targetBPM - currentBPM) * 0.05;

            if (currentBPM < 5) {
                Tone.Transport.bpm.value = 0;
                if(Tone.Transport.state === "started") Tone.Transport.pause();
                 bpmIndicator.innerText = "PAUSA";
                 bpmIndicator.style.color = "#888";
            } else {
                if(Tone.Transport.state !== "started") Tone.Transport.start();
                Tone.Transport.bpm.value = currentBPM;
                bpmIndicator.innerText = Math.round(currentBPM) + " BPM";
                 bpmIndicator.style.color = "#00ffea";
            }
        }

        function drawBatonVisuals(x, y) {
            // Dibujar un orbe brillante en la punta del dedo
            const gradient = canvasCtx.createRadialGradient(x, y, 0, x, y, 30);
            gradient.addColorStop(0, 'rgba(255, 255, 255, 1)');
            gradient.addColorStop(0.3, 'rgba(0, 255, 234, 0.8)');
            gradient.addColorStop(1, 'rgba(0, 255, 234, 0)');

            canvasCtx.beginPath();
            canvasCtx.arc(x, y, 30, 0, 2 * Math.PI);
            canvasCtx.fillStyle = gradient;
            canvasCtx.fill();
        }

        /**
         * GESTIÓN DEL BOTÓN DE INICIO
         */
        startBtn.addEventListener('click', async () => {
            if (!isSystemReady) return;
            
            await Tone.start(); // Necesario por políticas de navegadores
            
            Tone.Transport.bpm.value = 0;
            part.start(0);
            
            document.body.classList.add('playing');
            isPlaying = true;
        });

        // Arrancar el sistema
        setup();

    </script>
</body>
</html>
