<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAESTRO - Simulador de Orquesta</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>

    <style>
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background-color: black; color: white;
            font-family: 'Times New Roman', serif; overflow: hidden;
        }
        .pantalla {
            display: none; position: absolute; width: 100%; height: 100%;
            flex-direction: column; justify-content: center; align-items: center; z-index: 10;
        }
        .activa { display: flex !important; }
        h1 { font-size: 80px; letter-spacing: 20px; font-weight: 200; }
        button {
            background-color: white; color: black; border: none;
            padding: 15px 45px; font-size: 18px; text-transform: uppercase;
            cursor: pointer; transition: 0.3s;
        }
        video, canvas {
            position: absolute; top: 0; left: 0; width: 100vw; height: 100vh;
            object-fit: cover; transform: scaleX(-1);
        }
        #ui-capa {
            position: relative; z-index: 100; background: rgba(0,0,0,0.7);
            padding: 30px; border-radius: 20px; text-align: center;
        }
        .flecha {
            position: absolute; font-size: 100px; color: yellow; z-index: 200;
            text-shadow: 0 0 20px orange; pointer-events: none;
            animation: aparecer 1s ease-out forwards;
        }
        @keyframes aparecer {
            from { transform: scale(0.5); opacity: 0; }
            to { transform: scale(1.2); opacity: 1; }
        }
        #cuenta { font-size: 150px; font-weight: bold; }
    </style>
</head>
<body>

    <div id="p-inicio" class="pantalla activa">
        <h1>MAESTRO</h1>
        <button onclick="comenzar()">JUGAR</button>
    </div>

    <div id="p-escaneo" class="pantalla">
        <video id="v-escaneo" style="opacity: 0.8;"></video>
        <canvas id="c-escaneo"></canvas>
        <div id="ui-capa">
            <h2 id="msg-escaneo">Analizando cuerpo...</h2>
            <div id="confirmar-escaneo" style="display:none;">
                <p>¿Los huesos están bien?</p>
                <button onclick="irACanciones()">SÍ</button>
                <button onclick="location.reload()" style="background:#444; color:white;">NO</button>
            </div>
        </div>
    </div>

    <div id="p-canciones" class="pantalla">
        <h1>SELECCIÓN</h1>
        <button onclick="iniciarJuego('Toreadores')" style="margin:10px; width:300px;">Les Toréadors</button>
        <button onclick="iniciarJuego('Novena')" style="margin:10px; width:300px;">Sinfonía No. 9</button>
        <button onclick="iniciarJuego('Primavera')" style="margin:10px; width:300px;">La Primavera</button>
    </div>

    <div id="p-juego" class="pantalla">
        <video id="v-juego" style="opacity: 0.8;"></video>
        <canvas id="c-juego"></canvas>
        <div id="ui-juego" style="z-index:150; text-align:center;">
            <h1 id="prep">PREPÁRATE</h1>
            <div id="cuenta"></div>
        </div>
        <div id="flechas-cont"></div>
    </div>

    <script>
        let stream, pose, hands;
        let progreso = 0;
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        function nav(id) {
            document.querySelectorAll('.pantalla').forEach(p => p.classList.remove('activa'));
            document.getElementById(id).classList.add('activa');
        }

        async function comenzar() {
            nav('p-escaneo');
            stream = await navigator.mediaDevices.getUserMedia({video: true});
            const v = document.getElementById('v-escaneo');
            v.srcObject = stream;
            v.play();
            v.onloadedmetadata = () => {
                const c = document.getElementById('c-escaneo');
                c.width = v.videoWidth; c.height = v.videoHeight;
                iniciarEscaneo(v, c);
            };
        }

        function iniciarEscaneo(v, c) {
            pose = new Pose({locateFile: (f) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${f}`});
            pose.setOptions({modelComplexity: 1, smoothLandmarks: true});
            pose.onResults(results => {
                const ctx = c.getContext('2d');
                ctx.clearRect(0, 0, c.width, c.height);
                if (results.poseLandmarks) {
                    const lm = results.poseLandmarks;
                    ctx.strokeStyle = "white"; ctx.lineWidth = 4;
                    if(progreso > 20) drawConnectors(ctx, [lm[0]], []); // Cabeza
                    if(progreso > 50) drawConnectors(ctx, lm, [[11,12], [11,13], [12,14]], {color: 'white'}); // Torso/Brazos
                    if(progreso > 80) drawConnectors(ctx, lm, [[13,15], [14,16]], {color: 'white'}); // Manos
                }
            });

            let t = setInterval(() => {
                progreso += 2;
                pose.send({image: v});
                if(progreso >= 100) {
                    clearInterval(t);
                    document.getElementById('msg-escaneo').style.display = 'none';
                    document.getElementById('confirmar-escaneo').style.display = 'block';
                }
            }, 100);
        }

        function irACanciones() { nav('p-canciones'); }

        function iniciarJuego(obra) {
            nav('p-juego');
            const v = document.getElementById('v-juego');
            v.srcObject = stream; v.play();
            const c = document.getElementById('c-juego');
            c.width = v.videoWidth; c.height = v.videoHeight;

            let segs = 3;
            const cuentaDiv = document.getElementById('cuenta');
            const timer = setInterval(() => {
                document.getElementById('prep').style.display = 'none';
                cuentaDiv.innerText = segs;
                if(segs <= 0) {
                    clearInterval(timer);
                    cuentaDiv.style.display = 'none';
                    motorJuego(v, c, obra);
                }
                segs--;
            }, 1000);
        }

        function motorJuego(v, c, obra) {
            hands = new Hands({locateFile: (f) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`});
            hands.setOptions({maxNumHands: 2, minDetectionConfidence: 0.6});
            hands.onResults(res => {
                const ctx = c.getContext('2d');
                ctx.clearRect(0,0,c.width, c.height);
                if(res.multiHandLandmarks) {
                    res.multiHandLandmarks.forEach(lm => {
                        drawConnectors(ctx, lm, HAND_CONNECTIONS, {color: '#00FF00', lineWidth: 5});
                    });
                }
            });

            setInterval(() => hands.send({image: v}), 50);
            
            // Sonido y Flechas
            const intervaloFlechas = (obra === 'Toreadores') ? 1000 : 1500;
            setInterval(() => {
                crearFlecha();
                tocarNota();
            }, intervaloFlechas);
        }

        function tocarNota() {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.type = 'triangle'; osc.frequency.value = 440;
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            osc.start(); gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.5);
            osc.stop(audioCtx.currentTime + 0.5);
        }

        function crearFlecha() {
            const cont = document.getElementById('flechas-cont');
            const f = document.createElement('div');
            f.className = 'flecha';
            const dirs = ['↑', '↓', '←', '→', '↗', '↘'];
            f.innerText = dirs[Math.floor(Math.random()*dirs.length)];
            f.style.left = Math.random() * 70 + 15 + '%';
            f.style.top = Math.random() * 70 + 15 + '%';
            cont.appendChild(f);
            setTimeout(() => f.remove(), 1000);
        }
    </script>
</body>
</html>
