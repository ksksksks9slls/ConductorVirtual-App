<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Maestro AI 14.0</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #000; overflow: hidden; font-family: sans-serif; }
        .input_video { position: fixed; width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); z-index: 0; opacity: 0.6; }
        .output_canvas { position: fixed; width: 100%; height: 100%; z-index: 1; transform: scaleX(-1); pointer-events: none; }
        
        #ui-layer { position: fixed; inset: 0; z-index: 10; display: flex; flex-direction: column; justify-content: center; align-items: center; background: rgba(0,0,0,0.6); text-align: center; }
        .panel { background: rgba(20, 20, 20, 0.95); padding: 25px; border-radius: 25px; border: 2px solid #fff; width: 85%; max-width: 380px; color: white; }
        
        .btn { padding: 15px; background: #fff; color: #000; border: none; border-radius: 50px; font-weight: bold; cursor: pointer; width: 100%; text-transform: uppercase; margin: 10px 0; font-size: 0.9em; }
        .btn-neg { background: #ff4444; color: white; }
        #status-msg { margin: 15px 0; font-weight: bold; color: #00ffea; }
        #tempo-hud { position: fixed; top: 20px; right: 20px; font-size: 1.5em; color: white; z-index: 5; background: rgba(0,0,0,0.5); padding: 10px; border-radius: 10px; display: none; }
    </style>
</head>
<body>

    <video class="input_video" playsinline muted></video>
    <canvas class="output_canvas"></canvas>
    <div id="tempo-hud">TEMPO: 100%</div>

    <div id="ui-layer">
        <div id="panel-content" class="panel">
            <h2 id="title">MAESTRO AI 14.0</h2>
            <div id="actions">
                <input type="file" id="audio-input" accept="audio/*" style="display:none">
                <button class="btn" onclick="document.getElementById('audio-input').click()">SUBIR MÚSICA</button>
            </div>
            <div id="status-msg">POR FAVOR, CARGA UN ARCHIVO</div>
        </div>
    </div>

    <script>
        const videoElement = document.querySelector('.input_video');
        const canvasElement = document.querySelector('.output_canvas');
        const canvasCtx = canvasElement.getContext('2d');
        const audioInput = document.getElementById('audio-input');

        let player, isPlaying = false;
        let flowState = "START"; 
        let calProgress = 0, golpesDados = 0;
        let lastY = 0, subiendo = false, detectadoEnAlto = false;
        let currentTempo = 1.0;

        const woodTap = new Tone.MembraneSynth({ envelope: { attack: 0.001, decay: 0.1, sustain: 0 } }).toDestination();

        audioInput.onchange = async (e) => {
            if (e.target.files[0]) {
                await Tone.start();
                player = new Tone.Player(URL.createObjectURL(e.target.files[0])).toDestination();
                flowState = "SCANNING";
                updateUI();
                initPose();
            }
        };

        function updateUI() {
            const actions = document.getElementById('actions');
            const title = document.getElementById('title');
            
            if (flowState === "SCANNING") {
                title.innerText = "ESCANEO DE CUERPO";
                actions.innerHTML = "";
            } else if (flowState === "CONFIRMATION") {
                title.innerText = "¿ES CORRECTO?";
                actions.innerHTML = `
                    <p style="font-size:0.8em">¿Los huesos coinciden con tu cuerpo?</p>
                    <button class="btn" onclick="confirmScan(true)">SÍ, ESTÁ BIEN</button>
                    <button class="btn btn-neg" onclick="confirmScan(false)">NO, REPETIR</button>
                `;
            } else if (flowState === "RITUAL") {
                document.getElementById('ui-layer').style.background = "transparent";
                document.getElementById('panel-content').style.display = "none";
                document.getElementById('status-msg').style.display = "none";
                document.getElementById('tempo-hud').style.display = "block";
                flowState = "WAITING_HAND";
            }
        }

        function confirmScan(ok) {
            if (ok) {
                flowState = "RITUAL";
                updateUI();
            } else {
                calProgress = 0;
                flowState = "SCANNING";
                updateUI();
            }
        }

        function initPose() {
            const pose = new Pose({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`});
            pose.setOptions({ modelComplexity: 1, smoothLandmarks: true, minDetectionConfidence: 0.5 });
            pose.onResults(onResults);
            new Camera(videoElement, { onFrame: async () => { await pose.send({image: videoElement}); }, width: 640, height: 480 }).start();
        }

        function onResults(results) {
            canvasElement.width = window.innerWidth;
            canvasElement.height = window.innerHeight;
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);

            if (results.poseLandmarks) {
                const lm = results.poseLandmarks;
                drawAnatomicSkeleton(lm);

                if (flowState === "SCANNING") {
                    calProgress += 1;
                    document.getElementById('status-msg').innerText = `ANALIZANDO: ${Math.round(calProgress)}%`;
                    if (calProgress >= 100) { flowState = "CONFIRMATION"; updateUI(); }
                }

                const hand = lm[16]; // Mano derecha por defecto

                if (flowState === "WAITING_HAND") {
                    canvasCtx.fillStyle = "white";
                    canvasCtx.font = "30px Arial";
                    canvasCtx.textAlign = "center";
                    canvasCtx.fillText("LEVANTA LA MANO", canvasElement.width/2, 100);
                    
                    if (hand.y < 0.4) {
                        flowState = "READY_GOLPES";
                    }
                }

                if (flowState === "READY_GOLPES") {
                    canvasCtx.fillStyle = "#00ffea";
                    canvasCtx.font = "30px Arial";
                    canvasCtx.textAlign = "center";
                    canvasCtx.fillText("¡DA 3 GOLPES SECOS!", canvasElement.width/2, 100);

                    if (lastY < hand.y - 0.08 && !subiendo) {
                        woodTap.triggerAttackRelease("G2", "16n");
                        golpesDados++;
                        subiendo = true;
                        if (golpesDados >= 3) {
                            player.start();
                            isPlaying = true;
                            flowState = "PLAYING";
                        }
                    }
                    if (hand.y < lastY - 0.06) subiendo = false;
                }

                if (isPlaying) {
                    const speed = Math.abs(hand.y - lastY) * 100;
                    
                    // Algoritmo de tempo variable continuo
                    // Mapeamos la velocidad de 0.0 a 2.0+ a un rango de 0.5x a 2.0x
                    let target = 0.5 + (speed / 5); 
                    target = Math.min(Math.max(target, 0.6), 2.0); // Limites suaves
                    
                    currentTempo = (currentTempo * 0.9) + (target * 0.1); // Suavizado
                    player.playbackRate = currentTempo;
                    document.getElementById('tempo-hud').innerText = `TEMPO: ${Math.round(currentTempo * 100)}%`;
                }
                lastY = hand.y;
            }
        }

        function drawAnatomicSkeleton(lm) {
            const p = (i) => ({ x: lm[i].x * canvasElement.width, y: lm[i].y * canvasElement.height });
            canvasCtx.strokeStyle = "white";
            canvasCtx.lineWidth = 4;

            const line = (a, b) => {
                canvasCtx.beginPath();
                canvasCtx.moveTo(a.x, a.y);
                canvasCtx.lineTo(b.x, b.y);
                canvasCtx.stroke();
            };

            // 1. Línea de hombro a hombro
            line(p(11), p(12));

            // 2. Líneas de brazos hasta dedo medio (hueso simplificado hasta el final)
            // Brazo derecho: hombro -> codo -> muñeca -> punta dedo
            line(p(12), p(14)); line(p(14), p(16)); line(p(16), p(20));
            // Brazo izquierdo: hombro -> codo -> muñeca -> punta dedo
            line(p(11), p(13)); line(p(13), p(15)); line(p(15), p(19));

            // 3. Línea central: Cuello (punto medio hombros) hasta el "Pene" (punto medio cadera)
            const cuello = { x: (p(11).x + p(12).x)/2, y: (p(11).y + p(12).y)/2 };
            const pelvis = { x: (p(23).x + p(24).x)/2, y: (p(23).y + p(24).y)/2 };
            line(cuello, pelvis);
            
            // Puntos en articulaciones para realismo
            [11, 12, 13, 14, 15, 16, 19, 20, 23, 24].forEach(i => {
                canvasCtx.fillStyle = "#00ffea";
                canvasCtx.beginPath();
                canvasCtx.arc(p(i).x, p(i).y, 5, 0, 7);
                canvasCtx.fill();
            });
        }
    </script>
</body>
</html>
